# Stilstaande wateren

```{r}
types_habcat <- read_types() %>%
  filter(tag_1 == "SW")

habcat_name <- "standing_water"
habcat_code <- "sw"
```


```{r}
lsvi_detail <- read_vc(file = "HT31xx_ResDetail", root = path_lsvi_aq)

colnames(lsvi_detail) <- str_to_lower(colnames(lsvi_detail))

lsvi_indicator <- read_vc(file = "HT31xx_ResInd", root = path_lsvi_aq)

lsvi_globaal <- lsvi_indicator %>%
  filter(!is.na(Status_indicator)) %>%
  group_by(ID, Criterium) %>%
  mutate(weight_crit = 1/n()) %>%
  ungroup() %>%
  group_by(Versie, Kwaliteitsniveau, ID, Habitattype) %>%
  summarise(n_gunstig = sum(Status_indicator),
            n_ind = n_distinct(Indicator),
            n_zb_ongunstig = sum(Status_indicator == FALSE & Belang == "zb"),
            aandeel_gunstig = n_gunstig / n_ind * 100,
            status_habitatvlek =  n_zb_ongunstig == 0 & aandeel_gunstig > 50,
            index_mean_ind = round(mean(Verschilscore), 6),
            index_mean_crit = round(sum(weight_crit * Verschilscore) / sum(weight_crit), 6)
            ) %>%
  ungroup() %>%
  mutate(Aggregatiemethode = "RapportageHR") %>%
  select(Versie, Kwaliteitsniveau, ID, Habitattype, Aggregatiemethode, n_zb_ongunstig, aandeel_gunstig, Status = status_habitatvlek, index_mean_ind, index_mean_crit)

colnames(lsvi_indicator) <- str_to_lower(colnames(lsvi_indicator))
colnames(lsvi_globaal) <- str_to_lower(colnames(lsvi_globaal))

measurements_ws_all <- measurements_ws_all %>%
  mutate(id = recording_givid)

check <- lsvi_detail %>%
  filter(str_sub(habitattype, 1, 4) == "3130") %>%
  group_by(location, voorwaarde, date) %>%
  filter(n_distinct(habitattype) > 1)
```

```{r}

ht3110_verdwenen <- data.frame(code_watersurfaces = c("ANTTUR0304", "LIMHHE0002"),
                               type = "3110")

mhq_su <- measurements_ws_all %>%
  mutate(type = type_observed,
         main_type = str_sub(type, 1, 4)) %>%
  filter(ws_type %in% c("mhq_sampleframe", "mhq_sample")) %>%
  anti_join(ht3110_verdwenen, by = c("code_watersurfaces", "type")) %>%
  filter(suitable_mhq) %>%
  select(id, code_watersurfaces, main_type, type, date, ws_type) %>%
  left_join(ws_area, by = "code_watersurfaces") %>%
  group_by(code_watersurfaces, date) %>%
  mutate(area_ha_type = area_ha / n_distinct(type)) %>% #plassen die verschillende types bevatten
  ungroup()

check <- mhq_su %>%
  group_by(code_watersurfaces, date) %>%
  filter(n() > 1)

check_area <- mhq_su %>%
  filter(is.na(area_ha))
#	ANTLIL0230 niet in watervlakken v6? 

mhq_su_recent <- mhq_su %>%
  filter(!is.na(area_ha)) %>%
  filter(ws_type == "mhq_sample") %>%
  group_by(code_watersurfaces, type) %>%
  filter(date == max(date)) %>%
  ungroup() %>%
  group_by(main_type, type, in_sac, area_class) %>%
  mutate(n_stratum = n_distinct(code_watersurfaces),
         area_stratum_ha = sum(area_ha_type)) %>%
  ungroup()  %>%
  left_join(type_ws_area, by = c("type", "in_sac", "area_class")) %>%
  mutate(weight_stratum = area_flanders_ha / area_stratum_ha,
         weight_ws = weight_stratum * area_ha_type)

check <- mhq_su_recent %>%
  filter(area_ha != area_ha_type) %>%
  group_by(type) %>%
  summarise(verschil = sum(area_ha - area_ha_type))

weights_recent_table <- mhq_su_recent %>%
  group_by(main_type) %>%
  mutate(year_min = min(year(date)),
         year_max = max(year(date))) %>%
  ungroup() %>%
  distinct(year_min, year_max, main_type, type, in_sac, area_class, area_flanders_ha, n_stratum, area_stratum_ha,  weight_stratum) %>%
  arrange(main_type, type, in_sac)

check <- mhq_su_recent %>%
  group_by(id) %>%
  filter(n() > 1)

mhq_su_remeasured <- mhq_su %>%
  group_by(code_watersurfaces, main_type, type) %>%
  filter(n_distinct(date) > 1,
         (year(max(date)) - year(min(date)) >= 3 )) %>%
  mutate(n_measured = n_distinct(date),
         n_check = n(),
         periode = ifelse(date == min(date), "c_1",
                          ifelse(date == max(date), "c_2", "extra")),
         diff_years = max(year(date)) - min(year(date))) %>%
  ungroup()

weights_remeasured <- mhq_su_remeasured %>%
  group_by(main_type, periode) %>%
    mutate(year_min = min(year(date)),
           year_max = max(year(date))) %>%
  ungroup() %>%
  group_by(periode, year_min, year_max, main_type, type, in_sac, area_class) %>%
  summarise(n_stratum = n_distinct(code_watersurfaces),
            verschil_jaar = round(mean(diff_years), 1),
         area_stratum_ha = sum(area_ha_type)) %>%
  ungroup()  %>%
  left_join(type_ws_area, by = c("type", "in_sac", "area_class")) %>%
  mutate(weight_stratum = area_flanders_ha / area_stratum_ha)

mhq_su_remeasured <- mhq_su_remeasured %>%
  left_join(weights_remeasured, by = c("periode", "main_type", "type", "in_sac", "area_class")) %>%
  mutate( weight_ws = weight_stratum * area_ha_type)
  

```

## Gewichten

### Toestand

```{r}
weights_recent_table  %>%
  arrange(main_type) %>%
  datatable(rownames = FALSE,
            filter = "top",
            caption = "Gewichten toestand habitatkwaliteit")
```


### Trend

```{r}
weights_remeasured  %>%
  datatable(rownames = FALSE,
            filter = "top",
            caption = "Gewichten trend habitatkwaliteit")
```


## Status per plot

```{r}
lsvi_voorwaarde <- lsvi_detail %>%
  mutate(type = habitattype) %>%
  inner_join(select(mhq_su, id, type, main_type, in_sac, area_class, code_watersurfaces), by = c("id", "type")) 

check <- mhq_su %>%
  anti_join(lsvi_voorwaarde, by = c("code_watersurfaces", "type"))
# WVLKNO0061?

lsvi_indicator <- lsvi_indicator %>%
  mutate(type = habitattype) %>%
  inner_join(select(mhq_su, id, type, main_type, in_sac, area_class, code_watersurfaces), by = c("id", "type")) 

lsvi_habitat <- lsvi_globaal %>%
  mutate(type = habitattype) %>%
  inner_join(select(mhq_su, id, type, main_type, in_sac, area_class, code_watersurfaces), by = c("id", "type")) 
```


## Status Vlaanderen

```{r}
output_path <- file.path(fileman_up("n2khab-mhq-data"), str_c("processed/lsvi_mhq/", habcat_name,"/result"))
```

### Meest recente toestand habitatkwaliteit per meetpunt

```{r}
mhq_su_recent %>%
  group_by(main_type) %>%
  summarise(year_min = min(year(date)),
            year_max = max(year(date)),
            n_ws = n_distinct(code_watersurfaces),
            area_measured = round(sum(area_ha_type), 1)) %>%
  ungroup() %>%
  mutate(periode = str_c(year_min, " - ", year_max)) %>%
  select(habitattype = main_type, n_ws, area_measured, periode) %>%
  kable(caption = "Periode toestand habitatkwaliteit") %>%
  kable_styling()

check <- mhq_su_recent %>%
  distinct(code_watersurfaces, main_type, area_ha) %>%
  group_by(main_type) %>%
  summarise(area_tot = sum(area_ha)) %>%
  ungroup()

```


#### Aandeel gunstig

+ Steekproef

```{r}

lsvi_habitat_recent <- lsvi_habitat %>%
  inner_join(select(mhq_su_recent, id, weight_ws, weight_stratum, area_ha, area_ha_type, date), by = "id") %>%
  mutate(weight = weight_ws) %>%
  mutate(weight = ifelse(is.na(weight), 1, weight),
         is_integraal = main_type == "3110" | 
                        area_class == ">= 50 ha" | 
                        (main_type == "2190" & area_class == "1 ha < area <= 5 ha"))

lsvi_habitat_recent_sample <- lsvi_habitat_recent %>%
  filter(!is_integraal)

status_flanders_sample <- calc_status_habitat(lsvi_habitat_recent_sample) %>%
  mutate(habitattype = factor(habitattype, levels = levels(types_habcat$type)))

```

+ integraal

```{r}
lsvi_habitat_recent_integraal <- lsvi_habitat_recent %>%
  filter(is_integraal)

lsvi_missing <- ws_hab_type %>%
  mutate(main_type = str_sub(type, 1, 4)) %>%
  filter(area_class == ">= 50 ha" | type == "3110" | (main_type == "2190" & area_class == "1 ha < area <= 5 ha")) %>%
  anti_join(lsvi_habitat_recent, by = c("code_watersurfaces", "type")) %>%
  group_by(code_watersurfaces) %>%
  mutate(area_ha_type = area_ha / n_distinct(type)) %>%
  ungroup()

lsvi_habitat_recent_integraal <- lsvi_habitat_recent_integraal %>%
  bind_rows(lsvi_missing)

subtype_integraal <- lsvi_habitat_recent_integraal %>%
  filter(str_detect(type, "_")) %>%
  group_by(type) %>%
  summarise(area_unknown_ha = sum(area_ha_type * is.na(status)),
            area_measured_int_ha = sum(area_ha_type * !is.na(status)),
            area_gunstig_int_ha = sum(area_ha_type * status, na.rm = TRUE),
            n_obs_int = n_distinct(code_watersurfaces)) %>%
  ungroup() %>%
  rename( habitatsubtype = type)

maintype_integraal <- lsvi_habitat_recent_integraal %>%
  group_by(main_type) %>%
  summarise(area_unknown_ha = sum(area_ha_type * is.na(status)),
            area_measured_int_ha = sum(area_ha_type * !is.na(status)),
            area_gunstig_int_ha = sum(area_ha_type * status, na.rm = TRUE),
            n_obs_int = n_distinct(code_watersurfaces)) %>%
  ungroup() %>%
  rename(habitattype = main_type)

sac_integraal <-  lsvi_habitat_recent_integraal %>%
  group_by(main_type, in_sac) %>%
  summarise(area_unknown_ha = sum(area_ha_type * is.na(status)),
            area_measured_int_ha = sum(area_ha_type * !is.na(status)),
            area_gunstig_int_ha = sum(area_ha_type * status, na.rm = TRUE),
            n_obs_int = n_distinct(code_watersurfaces)) %>%
  ungroup() %>%
  rename(habitattype = main_type) %>%
  mutate(sbzh = ifelse(in_sac, "Binnen", "Buiten")) %>%
  select(-in_sac)
  
```

+ integratie

```{r}

areas_habt_sample <- weights_recent_table %>%
  filter(!(area_class == ">= 50 ha" | type == "3110" | (main_type == "2190" & area_class == "1 ha < area <= 5 ha"))) %>%
  group_by(main_type) %>%
  summarise(area_sample_ha = sum(area_flanders_ha)) %>%
  ungroup() %>%
  rename(habitattype = main_type) 

areas_sac_sample <- weights_recent_table %>%
  filter(!(area_class == ">= 50 ha" | type == "3110" | (main_type == "2190" & area_class == "1 ha < area <= 5 ha"))) %>%
  group_by(main_type, in_sac) %>%
  summarise(area_sample_ha = sum(area_flanders_ha)) %>%
  ungroup() %>%
  rename(habitattype = main_type) %>%
  mutate(sbzh = ifelse(in_sac, "Binnen", "Buiten")) %>%
  select(-in_sac)

areas_subt_sample <- weights_recent_table %>%
  filter(!(area_class == ">= 50 ha" | type == "3110" | (main_type == "2190" & area_class == "1 ha < area <= 5 ha"))) %>%
  group_by(type) %>%
  summarise(area_sample_ha = sum(area_flanders_ha)) %>%
  ungroup() %>%
  rename(habitatsubtype = type) 

sac2190_missing <- status_flanders_sample %>%
  filter(habitattype %in% c("2190")) %>%
  mutate(type_resultaat = "SBZH",
         sbzh = "Binnen")

ht3110_missing  <- status_flanders_sample %>%
  distinct(versie, schaal, type_resultaat, sbzh) %>%
  mutate(habitattype = "3110",
         habitatsubtype = "3110",
         aandeel_gunstig = 0,
         n_obs = 0) %>%
  filter(sbzh != "Buiten") %>% # enkel plassen binnen SBZH
  filter(type_resultaat != "Habitatsubtype")
  
status_flanders_sample <- status_flanders_sample %>%
  bind_rows(sac2190_missing,
            ht3110_missing)

status_flanders_habt <- status_flanders_sample %>%
  filter(type_resultaat == "Habitattype") %>%
  left_join(areas_habt_sample, by = "habitattype") %>%
  left_join(maintype_integraal, by = "habitattype") 

status_flanders_sbzh <- status_flanders_sample %>%
  filter(type_resultaat == "SBZH") %>%
  left_join(areas_sac_sample, by = c("habitattype", "sbzh")) %>%
  left_join(sac_integraal, by = c("habitattype", "sbzh")) 

status_flanders_subt <- status_flanders_sample %>%
  filter(type_resultaat == "Habitatsubtype") %>%
  left_join(areas_subt_sample, by = c("habitatsubtype")) %>%
  left_join(subtype_integraal, by = c("habitatsubtype")) 

status_flanders <- status_flanders_habt %>%
  bind_rows(status_flanders_sbzh, status_flanders_subt) %>%
  mutate(area_gunstig_int_ha = ifelse(is.na(area_gunstig_int_ha), 0,  area_gunstig_int_ha),
         area_measured_int_ha = ifelse(is.na(area_measured_int_ha), 0,  area_measured_int_ha),
         area_unknown_ha = ifelse(is.na(area_unknown_ha), 0,  area_unknown_ha),
         area_sample_ha = ifelse(is.na(area_sample_ha), 0,  area_sample_ha),
         n_obs_int = ifelse(is.na(n_obs_int), 0, n_obs_int),
         n_obs = n_obs + n_obs_int,
         aandeel_gunstig = round((aandeel_gunstig * area_sample_ha + area_gunstig_int_ha) / (area_measured_int_ha + area_sample_ha), 2),
         aandeel_gunstig_ulci = round((aandeel_gunstig_ulci * area_sample_ha + area_gunstig_int_ha) / (area_measured_int_ha + area_sample_ha), 2),
         aandeel_gunstig_llci = round((aandeel_gunstig_llci * area_sample_ha + area_gunstig_int_ha) / (area_measured_int_ha + area_sample_ha), 2),
         opp_uitspraak_ha = round(area_measured_int_ha + area_sample_ha, 2),
         opp_onbekend_ha = round(area_unknown_ha, 2),
         opp_totaal_ha = opp_uitspraak_ha + opp_onbekend_ha) %>%
  select(-area_gunstig_int_ha, -area_measured_int_ha, -area_unknown_ha, -area_sample_ha) %>%
  mutate(beoordeling = ifelse(habitattype == "3110", 
                              ifelse(aandeel_gunstig < 75, "Niet goed", "Goed"),
                              ifelse(is.na(aandeel_gunstig_ulci), "Onbekend",
                                ifelse(aandeel_gunstig_llci >= 75, "Goed",
                                       ifelse(aandeel_gunstig_ulci < 75, "Niet goed",
                                              "Onbekend")))))

status_flanders %>%
  write_vc(root = output_path,
           file = str_c("status_habitat_", habcat_code),
           sorting = c("habitattype", "type_resultaat", "sbzh", "habitatsubtype"),
           strict = FALSE)
```


```{r}

beoordeling_colors <- c("Goed" = inbo_lichtgroen, "Niet goed" = inbo_rood, "Onbekend" = inbo_grijs)

status_flanders %>%
  filter(type_resultaat %in% c("Habitattype", "SBZH")) %>%
  filter(sbzh != "Buiten") %>%
  mutate(schaal = ifelse(sbzh == "Binnen", "Binnen SBZH", "Vlaanderen"),
         schaal = factor(schaal, levels = c("Vlaanderen", "Binnen SBZH"))) %>%
  ggplot(aes(x = habitattype, y = aandeel_gunstig/100, ymin = aandeel_gunstig_llci/100, ymax = aandeel_gunstig_ulci/100, colour = beoordeling)) +
  geom_point(size = 3, show.legend = TRUE) +
  geom_errorbar(width = 0.2, show.legend = TRUE) +
  geom_hline(yintercept = 0.75, linetype = 2) +
  facet_wrap(~ schaal) +
  labs(x = "Habitattype", y = "Aandeel habitat in goede toestand", colour = "Beoordeling") +
  scale_color_manual(values = beoordeling_colors, drop = FALSE) +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  coord_flip() +
  theme(legend.position = "bottom")
  
```

```{r}
status_flanders %>%
  filter(type_resultaat %in% c("Habitatsubtype")) %>%
  mutate(habitatsubtype = str_remove(habitatsubtype, str_c(habitattype, "_"))) %>%
  ggplot(aes(x = habitatsubtype, y = aandeel_gunstig/100, ymin = aandeel_gunstig_llci/100, ymax = aandeel_gunstig_ulci/100, colour = beoordeling)) +
  geom_point(size = 3, show.legend = TRUE) +
  geom_errorbar(width = 0.2, show.legend = TRUE) +
  geom_hline(yintercept = 0.75, linetype = 2) +
  facet_wrap(~ habitattype, scales = "free") +
  labs(x = "Habitatsubtype", y = "Aandeel habitat in goede toestand", colour = "Beoordeling") +
  scale_color_manual(values = beoordeling_colors, drop = FALSE) +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  coord_flip() +
  theme(legend.position = "bottom")
```

#### kwaliteitsindex

```{r}

index_hq <- calc_index_hq_habitat(lsvi_habitat_recent)

index_hq %>%
  write_vc(root = output_path,
           file = str_c("index_hq_", habcat_code),
           sorting = c("habitattype", "type_resultaat", "sbzh", "habitatsubtype"),
           strict = FALSE)
```

```{r}
index_hq %>%
  filter(type_resultaat %in% c("Habitattype", "SBZH")) %>%
  filter(sbzh != "Buiten") %>%
  mutate(schaal = ifelse(sbzh == "Binnen", "Binnen SBZH", 
                        ifelse(sbzh == "Buiten", "Buiten SBZH", "Vlaanderen")),
         schaal = factor(schaal, levels = c("Vlaanderen", "Binnen SBZH", "Buiten SBZH"))) %>%
  ggplot(aes(x = habitattype, y = index_hq_mean, ymin = index_hq_llci_0.95, ymax = index_hq_ulci_0.95)) +
  geom_point(size = 3) +
  geom_errorbar(width = 0.2) +
  geom_hline(yintercept = 0, linetype = 2) +
  facet_wrap(~ schaal) +
  labs(x = "Habitattype", y = "Gemiddelde habitatkwaliteitsindex") +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(limits = c(-1, 1)) +
  coord_flip()
  
```

```{r}
index_hq %>%
  filter(type_resultaat %in% c("Habitatsubtype")) %>%
  mutate(habitatsubtype = str_remove(habitatsubtype, str_c(habitattype, "_"))) %>%
  mutate(schaal = "Vlaanderen") %>%
  ggplot(aes(x = habitatsubtype, y = index_hq_mean, ymin = index_hq_llci_0.95, ymax = index_hq_ulci_0.95)) +
  geom_point() +
  geom_errorbar(width = 0.3) +
  geom_hline(yintercept = 0, linetype = 2) +
  facet_wrap(~ habitattype, scales = "free") +
  labs(x = "Habitatsubtype", y = "Gemiddelde habitatkwaliteitsindex") +
  lims(y = c(-1, 1)) +
  coord_flip()
```


### Meest recente toestand indicator per meetpunt

```{r, warning = FALSE}

lsvi_indicator_recent <- lsvi_indicator  %>%
  inner_join(select(mhq_su_recent, id, weight_ws, weight_stratum, area_ha, area_ha_type, date), by = "id") %>%
  mutate(weight = weight_ws) %>%
  mutate(weight = ifelse(is.na(weight), 1, weight))

status_indicatoren <- calc_status_indicator(lsvi_indicator_recent) %>%
  mutate(habitattype = factor(habitattype, levels = levels(types_habcat$type))) %>%
  arrange(habitattype)
  
status_indicatoren %>%
  write_vc(root = output_path,
           file = str_c("status_indicatoren", habcat_code),
           sorting = c("habitattype", "type_resultaat", "sbzh", "habitatsubtype", "criterium", "indicator"),
           strict = FALSE)
```

```{r}

for (habt in unique(status_indicatoren$habitattype)) {
  
  plot_ht <- status_indicatoren %>%
  filter(habitattype == habt) %>%
  filter(type_resultaat %in% c("Habitattype")) %>%
  ggplot(aes(x = indicator, 
             y = aandeel_gunstig/100, 
             shape = belang,
             ymin = aandeel_gunstig_llci/100, 
             ymax = aandeel_gunstig_ulci/100,
         colour = beoordeling)) + 
  geom_point(size = 4, alpha = 0.8) +
  geom_errorbar(width = 0.3, alpha = 0.8, linewidth = 1) +
  facet_grid(criterium ~ habitattype, scales = "free_y", space = "free") + 
  coord_flip() +
  labs(x = "Indicator",
       y = "Aandeel habitat in goede toestand per indicator") + 
  geom_hline(aes(yintercept = 0.75), 
             colour = "black", 
             size = 0.5, 
             linetype = "dashed", 
             alpha = 0.5)  +
   scale_color_manual(values = beoordeling_colors, drop = FALSE) +
  theme(strip.text.y = element_text(angle = 0), 
        legend.position = "bottom",) +
  scale_y_continuous(labels = scales::percent)
  
  plot(plot_ht)
  
}

```

## Trend Vlaanderen

### Trend habitatkwaliteit gepaarde plots

```{r}
mhq_su_remeasured %>%
  filter(periode != "extra") %>%
  group_by(main_type, periode) %>%
  summarise(year_min = min(year(date)),
            year_max = min(year_max),
            n_ws = n_distinct(code_watersurfaces),
            area_measured = sum(area_ha_type)) %>%
  ungroup() %>%
  mutate(periode_year = str_c(year_min, " - ", year_max)) %>%
  select(habitattype = main_type, meetcyclus = periode, periode = periode_year, n_ws, area_measured) %>%
  kable() %>%
  kable_styling() %>%
  collapse_rows(columns = 1)
```


#### Aandeel gunstig per periode

```{r}
lsvi_habitat_remeasured <- lsvi_habitat %>%
  inner_join(select(mhq_su_remeasured, id, weight = weight_ws, date, periode, diff_years), by = "id") %>%
  filter(!type %in% c("2190_a", "3140"))

periodes <- lsvi_habitat_remeasured %>%
  group_by(main_type, periode) %>%
  summarise(year_min = year(min(date)),
            year_max = year(max(date))) %>%
  ungroup()

trend_flanders <- bind_rows(
  calc_status_habitat(lsvi_habitat_remeasured %>%
                                                filter(periode == "c_1")) %>%
    mutate(periode = "c_1"),
  calc_status_habitat(lsvi_habitat_remeasured %>%
                                                filter(periode == "c_2")) %>%
    mutate(periode = "c_2")
  ) %>%
  left_join(periodes, by = c("periode", "habitattype" = "main_type")) %>%
  select(versie, schaal, periode, year_min, year_max, everything()) %>%
  mutate(habitattype = factor(habitattype, levels = levels(types_habcat$type)))

```

#### Verschil aandeel gunstig via mixed model

```{r, warning = FALSE}

lsvi_habitat <- lsvi_habitat_remeasured %>%
  filter(periode != "extra") %>%
  mutate(point_code = "code_watersurfaces")

lsvi_habitat_trend <- calc_trend_habitat(lsvi_habitat)
  
lsvi_habitat_trend_corr <- lsvi_habitat_trend %>%
  mutate(mean = ifelse(parameter == "verschil_aandeel_gunstig_abs" & habitattype == "3110", 0, mean),
         llci_0.95 = ifelse(parameter == "verschil_aandeel_gunstig_abs" & habitattype == "3110", NA, llci_0.95),
         ulci_0.95 = ifelse(parameter == "verschil_aandeel_gunstig_abs" & habitattype == "3110", NA, ulci_0.95))

lsvi_habitat_trend_3110_sac <- lsvi_habitat_trend_corr %>%
  filter(parameter == "verschil_aandeel_gunstig_abs" & habitattype == "3110") %>%
  mutate(type_resultaat = "SBZH",
         sbzh = "Binnen")

lsvi_habitat_trend_corr <- lsvi_habitat_trend_corr %>%
  bind_rows(lsvi_habitat_trend_3110_sac)

lsvi_habitat_trend_glm <- calc_trend_habitat(lsvi_habitat, re_location = FALSE)

lsvi_habitat_trend_corr %>%
  write_vc(root = output_path,
           file = str_c("trend_habitat_", habcat_code),
           sorting = c("periode", "habitattype", "type_resultaat", "sbzh", "habitatsubtype", "parameter"),
           strict = FALSE)
```


```{r}

klasse_color <- c(rev(traffic_palette(7)), "grey65", "grey35", "grey50") %>%
  setNames(
    c("++", "+", "+~", "~", "-~", "-", "--", "?+", "?-", "?")
  ) 
klasse_color[4] <- inbo_steun_blauw

lsvi_habitat_trend_corr %>%
  filter(parameter == "verschil_aandeel_gunstig_abs") %>%
  filter(sbzh != "Buiten") %>%
  filter(type_resultaat %in% c("Habitattype", "SBZH")) %>%
  mutate(schaal = ifelse(sbzh == "Binnen", "Binnen SBZH", "Vlaanderen"),
         schaal = factor(schaal, levels = c("Vlaanderen", "Binnen SBZH"))) %>%
  ggplot(aes(x = habitattype, y = mean/100, ymin = llci_0.95/100, ymax = ulci_0.95/100, label = klasse, colour = klasse)) +
  geom_point(size = 7) +
  geom_errorbar(width = 0.2, show.legend = TRUE) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_hline(yintercept = c(-0.1, 0.1), linetype = 3) +
  geom_text(size = 4, colour = "white") +
  labs(y = "Absoluut verschil aandeel habitat in goede toestand",
       x = "Habitattype") +
  facet_wrap(~ schaal) +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(labels = scales::percent, limits = c(-0.90,0.90)) +
  scale_colour_manual(values = klasse_color, labels = class_labels(lang = "nl")) +
  labs(colour = "Interpretatie trend") +
  coord_flip() +
  theme(legend.position = "bottom")
  

```



#### Mc Nemar Test

```{r}
remeasured_wide <- lsvi_habitat_remeasured %>%
  filter(periode != "extra") %>%
  mutate(code_watersurfaces = str_c(code_watersurfaces, "_", type)) %>%
  select(code_watersurfaces, in_sac, periode, date, main_type, type, weight, status, aandeel_gunstig, index_mean_ind) %>%
  pivot_wider(names_from = "periode", values_from = c("status", "aandeel_gunstig", "index_mean_ind", "date", "weight", "type")) %>%
  mutate(diff_year = year(date_c_2) - year(date_c_1),
         diff_index = index_mean_ind_c_2 - index_mean_ind_c_1,
         sbzh = ifelse(in_sac, "Binnen", "Buiten"),
         point_code = code_watersurfaces)

```

```{r}

trend_local <- calc_trend_local(remeasured_wide)

results_mcnemar <- calc_mcnemar(remeasured_wide)

```

```{r}
mcnemar_main_type <- results_mcnemar %>%
  filter(type_resultaat == "Habitattype") %>%
  select(habitattype, mcnemar_p_value, effect) 

mcnemar_main_type %>%
  kable() %>%
  kable_styling()

trend_local %>% 
  filter(type_resultaat == "Habitattype") %>%
  left_join(mcnemar_main_type, by = "habitattype") %>%
  write_vc(root = output_path,
           file = str_c("mc_nemar_", habcat_code),
           sorting = c("habitattype", "type_resultaat", "sbzh", "habitatsubtype", "schaal", "mcnemar_p_value"),
           strict = FALSE)
```


```{r}

trend_colors <- c("gunstig - gunstig" = inbo_donkergroen, "ongunstig - ongunstig" = inbo_donkerblauw, "gunstig - ongunstig" = inbo_rood,
                  "ongunstig - gunstig" = inbo_lichtgroen)

trend_local %>% 
  filter(type_resultaat == "Habitattype") %>%
  left_join(mcnemar_main_type, by = "habitattype") %>%
  mutate(habitattype = ifelse(effect %in% c("+", "-"), str_c(habitattype, " (", effect, ")"), habitattype)) %>%
  ggplot(aes(x = habitattype, y = n_adj, fill = trend_local)) +
  geom_bar(stat = "identity") +
  labs(x = "Habitattype", y = "Gewogen aantal meetpunten", fill = "Trend per meetpunt") +
  scale_fill_manual(values = trend_colors)
```

```{r}
mcnemar_sbzh <- results_mcnemar %>%
  filter(type_resultaat == "SBZH") %>%
  select(habitattype, sbzh, mcnemar_p_value, effect) 

mcnemar_sbzh %>%
  kable() %>%
  kable_styling() %>%
  collapse_rows(columns = 1)
```

```{r}
trend_local %>% 
  filter(type_resultaat == "SBZH") %>%
  left_join(mcnemar_sbzh, by = c("habitattype", "sbzh")) %>%
  mutate(sbzh = ifelse(effect %in% c("+", "-"), str_c(sbzh, " (", effect, ")"), sbzh)) %>%
  ggplot(aes(x = sbzh, y = n_adj, fill = trend_local)) +
  geom_bar(stat = "identity") +
  facet_wrap(~habitattype, scales = "free_x") +
  labs(x = "Habitattype", y = "Gewogen aantal meetpunten", fill = "Trend per meetpunt") +
  scale_fill_manual(values = trend_colors)
```

```{r}
mcnemar_subtype <- results_mcnemar %>%
  filter(type_resultaat == "Habitatsubtype") %>%
  select(habitattype, habitatsubtype, mcnemar_p_value, effect) 

mcnemar_subtype %>%
  kable() %>%
  kable_styling() %>%
  collapse_rows(columns = 1)
```

```{r}
trend_local %>% 
  filter(type_resultaat == "Habitatsubtype") %>%
  left_join(mcnemar_subtype, by = c("habitattype", "habitatsubtype")) %>%
  mutate(subtype = str_remove(habitatsubtype, habitattype),
         subtype = str_remove(subtype, "_"),
         subtype = ifelse(effect %in% c("+", "-"), str_c(subtype, " (", effect, ")"), subtype)) %>%
  ggplot(aes(x = subtype, y = n_adj, fill = trend_local)) +
  geom_bar(stat ="identity") +
  facet_wrap(~habitattype, scales = "free") +
  labs(x = "Habitattype", y = "Gewogen aantal meetpunten", fill = "Trend per meetpunt") +
  scale_fill_manual(values = trend_colors)
```

#### Gemiddeld Verschil kwaliteitsindex per plot

```{r}

lsvi_habitat_wide <- remeasured_wide

diff_index_hq <- calc_diff_index_hq_habitat(remeasured_wide, threshold = 0.05)

diff_index_hq %>%
  write_vc(root = output_path,
           file = str_c("trend_index_hq_", habcat_code),
           sorting = c("habitattype", "type_resultaat", "sbzh", "habitatsubtype"),
           strict = FALSE)

```


```{r}

diff_index_hq %>%
  filter(sbzh != "Buiten") %>%
  filter(type_resultaat %in% c("Habitattype", "SBZH")) %>%
  mutate(schaal = ifelse(sbzh == "Binnen", "Binnen SBZH", "Vlaanderen"),
         schaal = factor(schaal, levels = c("Vlaanderen", "Binnen SBZH"))) %>%
  ggplot(aes(x = habitattype, y = index_diff_mean, ymin = index_diff_llci_0.95, ymax = index_diff_ulci_0.95, label = klasse, colour = klasse)) +
  geom_point(size = 7) +
  geom_errorbar(width = 0.2, show.legend = TRUE) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_hline(yintercept = c(-0.05, 0.05), linetype = 3) +
  geom_text(size = 4, colour = "white") +
  labs(y = "Gemiddeld verschil habitatkwaliteitsindex",
       x = "Habitattype") +
  facet_wrap(~ schaal) +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(limits = c(-0.5, 0.5)) +
  scale_colour_manual(values = klasse_color, labels = class_labels(lang = "nl")) +
  labs(colour = "Interpretatie verschil") +
  coord_flip() +
  theme(legend.position = "bottom")
```




```{r}
diff_index_hq %>%
  filter(type_resultaat %in% c("Habitatsubtype")) %>%
  filter(!is.na(klasse)) %>%
  mutate(habitatsubtype = str_remove(habitatsubtype, str_c(habitattype, "_"))) %>%
  ggplot(aes(x = habitatsubtype, y = index_diff_mean, ymin = index_diff_llci_0.95, ymax = index_diff_ulci_0.95, label = klasse, colour = klasse)) +
  geom_point(size = 7) +
  geom_errorbar(width = 0.2, show.legend = TRUE) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_hline(yintercept = c(-0.1, 0.1), linetype = 3) +
  geom_text(size = 4, colour = "white") +
  labs(y = "Gemiddeld verschil habitatkwaliteitsindex",
       x = "Habitatsubtype") +
  facet_wrap(~ habitattype, scales = "free") +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(limits = c(-0.5, 0.5)) +
  scale_colour_manual(values = klasse_color, labels = class_labels(lang = "nl")) +
  labs(colour = "Interpretatie verschil") +
  coord_flip() +
  theme(legend.position = "bottom")

```

### Trend indicatoren gepaarde plots

#### Aandeel gunstig per periode

```{r}
lsvi_indicatoren_remeasured <- lsvi_indicator %>%
  inner_join(select(mhq_su_remeasured, id, weight = weight_ws, date, periode, diff_years), by = "id") 

periodes <- lsvi_indicatoren_remeasured %>%
  group_by(main_type, periode) %>%
  summarise(year_min = year(min(date)),
            year_max = year(max(date))) %>%
  ungroup()

trend_indicator <- bind_rows(
  calc_status_indicator(lsvi_indicatoren_remeasured %>%
                                                filter(periode == "c_1")) %>%
    mutate(periode = "c_1"),
  calc_status_indicator(lsvi_indicatoren_remeasured %>%
                                                filter(periode == "c_2")) %>%
    mutate(periode = "c_2")
  ) %>%
  left_join(periodes, by = c("periode", "habitattype" = "main_type")) %>%
  select(versie, schaal, periode, year_min, year_max, everything()) %>%
  mutate(habitattype = factor(habitattype, levels = levels(types_habcat$type)))
  
colnames(trend_indicator) <- str_to_lower(colnames(trend_indicator))

```

#### Verschil aandeel gunstig via mixed model

```{r, warning = FALSE}

lsvi_indicatoren <- lsvi_indicatoren_remeasured %>%
  filter(periode != "extra") %>%
  mutate(point_code = code_watersurfaces)

lsvi_indicator_trend <- calc_trend_indicator(lsvi_indicatoren) %>%
  arrange(habitattype)

lsvi_indicator_trend %>%
  write_vc(root = output_path,
           file = str_c("trend_indicatoren_", habcat_code),
           sorting = c("periode", "habitattype", "type_resultaat", "sbzh", "habitatsubtype", "criterium", "indicator"),
           strict = FALSE)

```

```{r}

for (ht in unique(lsvi_indicator_trend$habitattype)) {
  
  plot <- lsvi_indicator_trend %>%
  filter(habitattype == ht) %>%
  filter(parameter == "verschil_aandeel_gunstig_abs") %>%
  ggplot(aes(x = indicator, y = mean/100, ymin = llci_0.95/100, ymax = ulci_0.95/100, label = klasse, 
             shape = belang,
             colour = klasse)) +
  geom_point(size = 7) +
  geom_errorbar(width = 0.2, show.legend = TRUE) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_hline(yintercept = c(-0.1, 0.1), linetype = 3) +
  geom_text(size = 4, colour = "white") +
  labs(y = "Absoluut verschil aandeel habitat in goede toestand per indicator",
       x = "Habitattype") +
  facet_grid(criterium ~ habitattype, scales = "free", space = "free") +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(labels = scales::percent, limits = c(-1,1)) +
  scale_colour_manual(values = klasse_color, labels = class_labels(lang = "nl")) +
  labs(colour = "Interpretatie trend") +
  coord_flip() +
  theme(strip.text.y = element_text(angle = 0), 
        legend.position = "bottom")
  
  plot(plot)
  
}

```

#### Gemiddeld verschil kwaliteitsindex per indicator

```{r}
indicatoren_wide <- lsvi_indicatoren_remeasured %>%
  filter(periode != "extra") %>%
  mutate(code_watersurfaces = str_c(code_watersurfaces, "_", type)) %>% 
  mutate(sbzh = ifelse(in_sac, "Binnen", "Buiten")) %>%
  select(code_watersurfaces, sbzh, periode, date, main_type, type, weight, criterium, indicator, belang,  status_indicator, index = verschilscore) %>%
  pivot_wider(names_from = "periode", values_from = c("status_indicator", "index", "date", "type", "weight")) %>%
  mutate(diff_year = year(date_c_2) - year(date_c_1),
         diff_index = index_c_2 - index_c_1)

```

```{r}

diff_index_ind <- calc_diff_index_hq_indicator(indicatoren_wide, threshold = 0.1) %>%
  arrange(habitattype)

diff_index_ind %>%
  write_vc(root = output_path,
           file = str_c("trend_index_ind_", habcat_code),
           sorting = c("habitattype", "type_resultaat", "sbzh", "habitatsubtype", "indicator"),
           strict = FALSE)
```

```{r, fig.height= 6, fig.width=8}

for (habt in unique(diff_index_ind$habitattype)) {
  
  plot_ht <- diff_index_ind %>%
  filter(habitattype == habt) %>%
  filter(type_resultaat %in% c("Habitattype")) %>%
  ggplot(aes(x = indicator, 
             y = index_diff_mean, 
            # size = belang,
             ymin = index_diff_llci_0.95, 
             ymax = index_diff_ulci_0.95,
             label = klasse,
             colour = klasse,
             shape = belang)) + 
  geom_point(size = 7 ) +
  geom_errorbar(width = 0.3) +
    geom_text(colour = "white",
              size = 4) +
  facet_grid(criterium ~ habitattype, scales = "free_y", space = "free") + 
  coord_flip() +
  labs(x = "Indicator",
       y = "Gemiddeld verschil kwaliteitsindex",
       colour = "Interpretatie verschil",
       shape = "Belang indicator") + 
  geom_hline(yintercept = 0, linetype = "dashed")  +
  geom_hline(yintercept = c(-0.1,0.1), linetype = 3) +
    lims(y = c(-1.5, 1.5)) +
  scale_x_discrete(limits = rev) +
  scale_color_manual(values = klasse_color, labels = class_labels(lang = "nl")) +
  theme(strip.text.y = element_text(angle = 0), 
        legend.position = "bottom", legend.box = "vertical") +
  guides(shape = guide_legend(order = 1),
         colour = guide_legend(order = 2))
  
  plot(plot_ht)
  
}
```

